# Song Status System Documentation

## Overview

The Melodia song status system implements a two-level status tracking mechanism to provide real-time feedback during song generation. This system tracks both **variant-level statuses** (individual song versions) and **song-level statuses** (overall song state) based on the availability of streaming and download URLs from the Suno API.

## Status Levels

### 1. Variant-Level Status

Each song variant (typically 2 per song) has its own independent status that progresses through the following states:

#### `PENDING`
- **Condition**: No `sourceStreamAudioUrl` available
- **Meaning**: The variant is still being generated by Suno AI
- **UI Behavior**: Shows "Generating..." spinner

#### `STREAM_READY`
- **Condition**: `sourceStreamAudioUrl` is available, but no `audioUrl` or `sourceAudioUrl` yet
- **Meaning**: The variant can be streamed but download file is still processing
- **UI Behavior**:
  - Shows full streaming player with play/pause controls
  - Shows lyrics button
  - Shows "Stream ready - Download preparing..." status message
  - **No** download button (hidden)
  - Shows sharing options

#### `DOWNLOAD_READY`
- **Condition**: Both `sourceStreamAudioUrl` AND (`audioUrl` OR `sourceAudioUrl`) are available
- **Meaning**: The variant is fully ready for both streaming and downloading
- **UI Behavior**:
  - Shows full streaming player with play/pause controls
  - Shows lyrics button
  - Shows "Ready to download" status message
  - **Shows** download button
  - Shows sharing options

### 2. Song-Level Status

The overall song status is calculated based on all variant statuses:

#### `PENDING`
- **Condition**: All variants are in `PENDING` state (no `sourceStreamAudioUrl` for any variant)
- **Meaning**: Song generation has not progressed enough to show any playable content
- **UI Behavior**: Shows `SongCreationLoadingScreen` with timer and loading animation

#### `STREAM_AVAILABLE`
- **Condition**: At least one variant has `STREAM_READY` or `DOWNLOAD_READY` status
- **Meaning**: At least one variant can be played/streamed
- **UI Behavior**:
  - Shows `SongOptionsDisplay` component
  - Displays all variants with their individual statuses
  - Continues polling for updates

#### `COMPLETE`
- **Condition**: All variants are in `DOWNLOAD_READY` state
- **Meaning**: Song generation is fully complete
- **UI Behavior**:
  - Shows `SongOptionsDisplay` with all features enabled
  - **Stops** polling (no more status updates needed)

## Suno API Response Structure

The Suno API returns song data in the following format:

```json
{
  "taskId": "4bfeac734d4d07c800dbaf7671bb343a",
  "sunoData": [
    {
      "id": "854e5389-e3dd-49ba-9000-ec25daa6c04d",
      "audioUrl": "https://apiboxfiles.erweima.ai/...",
      "sourceAudioUrl": "https://cdn1.suno.ai/854e5389-e3dd-49ba-9000-ec25daa6c04d.mp3",
      "streamAudioUrl": "https://mfile.erweima.ai/...",
      "sourceStreamAudioUrl": "https://cdn1.suno.ai/854e5389-e3dd-49ba-9000-ec25daa6c04d.mp3",
      "imageUrl": "https://apiboxfiles.erweima.ai/...",
      "sourceImageUrl": "https://cdn2.suno.ai/image_854e5389-e3dd-49ba-9000-ec25daa6c04d.jpeg",
      "prompt": "Song lyrics and structure...",
      "modelName": "chirp-bluejay",
      "title": "Aap Hamara Abhimaan",
      "tags": "Semi-classical Indian ballad...",
      "createTime": 1759298219319,
      "duration": 281.6
    },
    {
      "id": "8bdb8113-8410-4982-8ced-d9fb0d078831",
      // Second variant with similar structure
    }
  ]
}
```

### Key URL Fields

- **`sourceStreamAudioUrl`**: Primary streaming URL (CDN-hosted) - **Key field for STREAM_READY status**
- **`streamAudioUrl`**: Alternative streaming URL (proxy)
- **`sourceAudioUrl`**: Primary download URL (CDN-hosted) - **Key field for DOWNLOAD_READY status**
- **`audioUrl`**: Alternative download URL (proxy)
- **`sourceImageUrl`**: Primary cover image URL
- **`imageUrl`**: Alternative image URL

## Status Calculation Logic

### Variant Status Calculation

```typescript
function calculateVariantStatus(variant: any): VariantStatus {
  // If no sourceStreamAudioUrl, variant is still PENDING
  if (!variant.sourceStreamAudioUrl) {
    return 'PENDING';
  }

  // If sourceStreamAudioUrl is available, variant is STREAM_READY
  if (variant.sourceStreamAudioUrl && !variant.audioUrl && !variant.sourceAudioUrl) {
    return 'STREAM_READY';
  }

  // If audioUrl or sourceAudioUrl is available, variant is DOWNLOAD_READY
  if (variant.audioUrl || variant.sourceAudioUrl) {
    return 'DOWNLOAD_READY';
  }

  return 'PENDING';
}
```

### Song Status Calculation

```typescript
function calculateSongStatus(variants: SongVariant[]): SongStatus {
  if (!variants || variants.length === 0) {
    return 'PENDING';
  }

  // Check if all variants are DOWNLOAD_READY
  const allDownloadReady = variants.every(v => v.variantStatus === 'DOWNLOAD_READY');
  if (allDownloadReady) {
    return 'COMPLETE';
  }

  // Check if at least one variant has STREAM_READY or DOWNLOAD_READY
  const anyStreamReady = variants.some(v =>
    v.variantStatus === 'STREAM_READY' || v.variantStatus === 'DOWNLOAD_READY'
  );
  if (anyStreamReady) {
    return 'STREAM_AVAILABLE';
  }

  // Otherwise, still PENDING
  return 'PENDING';
}
```

## Implementation Details

### Modified Files

#### 1. `/src/lib/song-status-client.ts`
**Purpose**: Client-side status calculation and type definitions

**Key Changes**:
- Added `VariantStatus` type: `'PENDING' | 'STREAM_READY' | 'DOWNLOAD_READY'`
- Added `SongStatus` type: `'PENDING' | 'STREAM_AVAILABLE' | 'COMPLETE'`
- Updated `SongVariant` interface to include:
  - `variantStatus: VariantStatus`
  - `sourceAudioUrl?: string`
  - `sourceStreamAudioUrl?: string`
  - `sourceImageUrl?: string`
- Added `calculateVariantStatus()` helper function
- Added `calculateSongStatus()` helper function
- Updated `convertToSongStatusResponse()` to calculate statuses from Suno data

#### 2. `/src/app/api/song-status/[songId]/route.ts`
**Purpose**: API endpoint that fetches and returns song status

**Key Changes**:

**Demo Mode**:
- Progressive simulation of variant status evolution:
  - **0-20s**: Both variants `PENDING` (no URLs)
  - **20-40s**: First variant `STREAM_READY`, second variant `PENDING`
  - **40-60s**: First variant `DOWNLOAD_READY`, second variant `STREAM_READY`
  - **60s+**: Both variants `DOWNLOAD_READY`

**Production Mode**:
- Returns raw Suno API response with all URL fields
- Client-side calculates statuses from available URLs
- Simplified response handling (removed old status-based conditionals)

#### 3. `/src/app/song-options/[songId]/page.tsx`
**Purpose**: Song options page with polling logic

**Key Changes**:
- Updated polling logic:
  - Continues polling until song status is `COMPLETE`
  - Stops polling when all variants are `DOWNLOAD_READY`
- Updated UI rendering logic:
  - Shows `SongCreationLoadingScreen` when status is `PENDING`
  - Shows `SongOptionsDisplay` when status is `STREAM_AVAILABLE` or `COMPLETE`
- Removed old status checks (`TEXT_SUCCESS`, `FIRST_SUCCESS`, etc.)

#### 4. `/src/components/SongOptionsDisplay.tsx`
**Purpose**: Displays song variants with appropriate controls

**Key Changes**:
- Replaced song-level status checks with variant-level status checks
- Updated status message display based on `variantStatus`
- Conditional rendering:
  - **PENDING**: Shows spinner with "Generating..."
  - **STREAM_READY**: Shows player without download button
  - **DOWNLOAD_READY**: Shows player with download button
- Uses `sourceStreamAudioUrl` or `streamAudioUrl` for streaming
- Uses `sourceAudioUrl` or `audioUrl` for downloads

## User Experience Flow

### Timeline Example

```
Time: 0s
├─ User initiates song generation
└─ Redirected to song options page

Time: 0-20s (PENDING)
├─ Song Status: PENDING
├─ Variant 1: PENDING
├─ Variant 2: PENDING
└─ UI: Shows SongCreationLoadingScreen with 45s timer

Time: 20-40s (STREAM_AVAILABLE)
├─ Song Status: STREAM_AVAILABLE
├─ Variant 1: STREAM_READY (sourceStreamAudioUrl available)
├─ Variant 2: PENDING
└─ UI: Shows SongOptionsDisplay
    ├─ Variant 1: Playable, no download
    └─ Variant 2: Generating...

Time: 40-60s (STREAM_AVAILABLE)
├─ Song Status: STREAM_AVAILABLE
├─ Variant 1: DOWNLOAD_READY (all URLs available)
├─ Variant 2: STREAM_READY
└─ UI: Shows SongOptionsDisplay
    ├─ Variant 1: Playable + Download button
    └─ Variant 2: Playable, no download

Time: 60s+ (COMPLETE)
├─ Song Status: COMPLETE
├─ Variant 1: DOWNLOAD_READY
├─ Variant 2: DOWNLOAD_READY
└─ UI: Shows SongOptionsDisplay
    ├─ Variant 1: Playable + Download button
    ├─ Variant 2: Playable + Download button
    └─ Polling stops
```

## Polling Strategy

### Configuration
- **Interval**: 10 seconds
- **Start Condition**: When song status is not `COMPLETE`
- **Stop Condition**: When song status becomes `COMPLETE`

### Progressive Enhancement
The system provides immediate feedback as soon as any content is ready:
1. User sees loading screen while waiting
2. As soon as first variant streaming is ready, options display appears
3. Download buttons appear individually as each variant becomes ready
4. Polling automatically stops when everything is complete

## Error Handling

### Missing URLs
- If `sourceStreamAudioUrl` is missing, variant stays `PENDING`
- If only `sourceStreamAudioUrl` exists, variant is `STREAM_READY` (functional)
- Download button only appears when download URLs exist

### Fallback URLs
- Streaming: Tries `sourceStreamAudioUrl` first, falls back to `streamAudioUrl`
- Download: Tries `audioUrl` first, falls back to `sourceAudioUrl`
- Images: Tries `imageUrl` first, falls back to `sourceImageUrl`

## Best Practices

### For Developers

1. **Always check variant status**: Use `variant.variantStatus` instead of song-level status for individual variant controls
2. **Use source URLs when available**: Prefer `sourceStreamAudioUrl` and `sourceAudioUrl` over proxy URLs for better performance
3. **Handle all states**: Ensure UI gracefully handles `PENDING`, `STREAM_READY`, and `DOWNLOAD_READY` states
4. **Stop polling**: Always stop polling when `COMPLETE` to avoid unnecessary API calls

### For Testing

1. **Demo Mode**: Use demo mode to test progressive status transitions
2. **Network Conditions**: Test with slow network to ensure streaming works before download
3. **URL Failures**: Test fallback behavior when primary URLs fail
4. **Multiple Variants**: Verify independent status tracking for each variant

## Migration Notes

### Old vs New Status System

**Old System**:
- Used Suno API statuses: `PENDING`, `TEXT_SUCCESS`, `FIRST_SUCCESS`, `SUCCESS`
- Single status for entire song
- No distinction between streaming and download readiness

**New System**:
- Custom statuses based on URL availability
- Two-level status tracking (variant + song)
- Progressive enhancement (stream → download)
- More granular user feedback

### Breaking Changes
- `SongVariant` interface now requires `variantStatus` field
- `downloadStatus` field is deprecated (use `variantStatus` instead)
- Song status values changed from Suno statuses to custom statuses

## TypeScript Definitions

```typescript
// Variant-level status
export type VariantStatus = 'PENDING' | 'STREAM_READY' | 'DOWNLOAD_READY';

// Song-level status
export type SongStatus = 'PENDING' | 'STREAM_AVAILABLE' | 'COMPLETE';

// Song variant interface
export interface SongVariant {
  id: string;
  title: string;
  audioUrl: string;
  sourceAudioUrl?: string;
  streamAudioUrl?: string;
  sourceStreamAudioUrl?: string;
  imageUrl: string;
  sourceImageUrl?: string;
  duration: number;
  variantStatus: VariantStatus;  // New field
  isLoading?: boolean;
  prompt?: string;
  modelName?: string;
  tags?: string;
  createTime?: string;
}

// Song status response
export interface SongStatusResponse {
  success: boolean;
  status: SongStatus;  // Changed from old Suno statuses
  audioUrl?: string;
  variants?: SongVariant[];
  message?: string;
  demoMode?: boolean;
}
```

## Conclusion

This two-level status system provides a more responsive and granular user experience by:
- Showing playable content as soon as possible (streaming)
- Enabling downloads individually as they become ready
- Providing clear feedback on generation progress
- Optimizing API polling behavior

The system is designed to handle the asynchronous nature of AI song generation while keeping users engaged with immediate feedback and progressive feature availability.

